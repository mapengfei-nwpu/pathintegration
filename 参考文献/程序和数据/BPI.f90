!基于泡泡网格的求解2维Duffing振子系统的无网格路径积分法：泡泡(BUBBLE)非均匀分布
USE DFPORT
IMPLICIT NONE
INTEGER*4, PARAMETER :: NE=2303,NL=10,NL0=50 !NE: NUMBER OF ELEMENT==NUMBER OF POINT, SINCE ELEMENT IS A CIRCLE
REAL*8   , PARAMETER :: ALPHA=1.0,BETA=0.3,YETA=0.1,FF=0.2,OMIGA=1.2,SEGMA2=0.01
REAL*8   , PARAMETER :: PI=3.1415926535898,PERIODM=2.0*PI/OMIGA,DT=PERIODM/4.0
REAL*8     ELEM(1:3,1:NE),AREAS(1:NE) !ELEM(:,I)=(XI,YI,RI)
COMMON     ELEM,AREAS
CALL ADVANCE
!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++!
CONTAINS
!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++!
SUBROUTINE ADVANCE
IMPLICIT   NONE
INTEGER*4  I,J,K
REAL*8     PM(1:3,1:NE),PM0(1:NE),MOMENTS(1:5,1:NE,1:NE),M10,M01,M11,M20,M02,TIMENOW
REAL*8     MEAN1,MEAN2,VAR1,VAR2,ROU12
REAL*8     QT
CALL INITIAL(PM)
TIMENOW=DT
DO  K=1,NL
	WRITE(*,'(I4,2X,F21.11,2X,A8)') K,TIMENOW,CLOCK()
	DO  I=1,NE
		IF  (MOD(I,100)==0)  THEN
			WRITE(*,'(6X,I4,2X,A8)') I,CLOCK()
		END IF
		PM0(I)=0.0D0
		DO  J=1,NE
			IF  (K==1)  THEN
				CALL UPDATEM(J,M10,M01,M11,M20,M02,PM,TIMENOW)
				MOMENTS(1,I,J)=M10
				MOMENTS(2,I,J)=M01
				MOMENTS(3,I,J)=M11
				MOMENTS(4,I,J)=M20
				MOMENTS(5,I,J)=M02
				MEAN1=M10
				MEAN2=M01
				VAR1=DSQRT(M20-M10**2.0)
				VAR2=DSQRT(M02-M01**2.0)
				ROU12=(M11-M10*M01)/(VAR1*VAR2)
				QT=VAR2**2.0*(PM(1,I)-MEAN1)**2.0-2.0*VAR1*VAR2*ROU12*(PM(1,I)-MEAN1)*(PM(2,I)-MEAN2)+VAR1**2.0*(PM(2,I)-MEAN2)**2.0
				QT=DEXP(-QT/(2.0*VAR1**2.0*VAR2**2.0*(1.0-ROU12**2.0)))
				QT=QT/(2.0*PI*VAR1*VAR2*DSQRT(1.0-ROU12**2.0))
				PM0(I)=PM0(I)+QT*PM(3,J)*AREAS(J)
			ELSE
				M10=MOMENTS(1,I,J)
				M01=MOMENTS(2,I,J)
				M11=MOMENTS(3,I,J)
				M20=MOMENTS(4,I,J)
				M02=MOMENTS(5,I,J)
				!CALL UPDATEM(J,M10,M01,M11,M20,M02,PM,TIMENOW)
				!MOMENTS(1,I,J)=M10
				!MOMENTS(2,I,J)=M01
				!MOMENTS(3,I,J)=M11
				!MOMENTS(4,I,J)=M20
				!MOMENTS(5,I,J)=M02
				MEAN1=M10
				MEAN2=M01
				VAR1=DSQRT(M20-M10**2.0)
				VAR2=DSQRT(M02-M01**2.0)
				ROU12=(M11-M10*M01)/(VAR1*VAR2)
				QT=VAR2**2.0*(PM(1,I)-MEAN1)**2.0-2.0*VAR1*VAR2*ROU12*(PM(1,I)-MEAN1)*(PM(2,I)-MEAN2)+VAR1**2.0*(PM(2,I)-MEAN2)**2.0
				QT=DEXP(-QT/(2.0*VAR1**2.0*VAR2**2.0*(1.0-ROU12**2.0)))
				QT=QT/(2.0*PI*VAR1*VAR2*DSQRT(1.0-ROU12**2.0))
				PM0(I)=PM0(I)+QT*PM(3,J)*AREAS(J)
			END IF
		END DO
	END DO
	OPEN(1,FILE='MID.DAT')
	DO  I=1,NE
	    PM(3,I)=PM0(I)
		WRITE(1,'(3(2X,F21.11))') PM(1,I),PM(2,I),PM(3,I)
	END DO
	CLOSE(1)
	IF  (K==1)  THEN
		OPEN(1,FILE='MID0.25T.DAT')
		DO  I=1,NE
			PM(3,I)=PM0(I)
			WRITE(1,'(3(2X,F21.11))') PM(1,I),PM(2,I),PM(3,I)
		END DO
		CLOSE(1)
	END IF
	IF  (K==2)  THEN
		OPEN(1,FILE='MID0.5T.DAT')
		DO  I=1,NE
			PM(3,I)=PM0(I)
			WRITE(1,'(3(2X,F21.11))') PM(1,I),PM(2,I),PM(3,I)
		END DO
		CLOSE(1)
	END IF
	IF  (K==3)  THEN
		OPEN(1,FILE='MID0.75T.DAT')
		DO  I=1,NE
			PM(3,I)=PM0(I)
			WRITE(1,'(3(2X,F21.11))') PM(1,I),PM(2,I),PM(3,I)
		END DO
		CLOSE(1)
	END IF
	IF  (K==4)  THEN
		OPEN(1,FILE='MID1.0T.DAT')
		DO  I=1,NE
			PM(3,I)=PM0(I)
			WRITE(1,'(3(2X,F21.11))') PM(1,I),PM(2,I),PM(3,I)
		END DO
		CLOSE(1)
	END IF
	IF  (K==5)  THEN
		OPEN(1,FILE='MID1.25T.DAT')
		DO  I=1,NE
			PM(3,I)=PM0(I)
			WRITE(1,'(3(2X,F21.11))') PM(1,I),PM(2,I),PM(3,I)
		END DO
		CLOSE(1)
	END IF
	IF  (K==6)  THEN
		OPEN(1,FILE='MID1.5T.DAT')
		DO  I=1,NE
			PM(3,I)=PM0(I)
			WRITE(1,'(3(2X,F21.11))') PM(1,I),PM(2,I),PM(3,I)
		END DO
		CLOSE(1)
	END IF
	IF  (K==7)  THEN
		OPEN(1,FILE='MID1.75T.DAT')
		DO  I=1,NE
			PM(3,I)=PM0(I)
			WRITE(1,'(3(2X,F21.11))') PM(1,I),PM(2,I),PM(3,I)
		END DO
		CLOSE(1)
	END IF
	IF  (K==8)  THEN
		OPEN(1,FILE='MID2.0T.DAT')
		DO  I=1,NE
			PM(3,I)=PM0(I)
			WRITE(1,'(3(2X,F21.11))') PM(1,I),PM(2,I),PM(3,I)
		END DO
		CLOSE(1)
	END IF
	TIMENOW=TIMENOW+DT
END DO
END SUBROUTINE ADVANCE
!-------------------------------------------------------------------------------------------------------------------------!
SUBROUTINE UPDATEM(LABEL,M10,M01,M11,M20,M02,PM,TM)      !UPDATE MOMENT
IMPLICIT   NONE
INTEGER*4  LABEL
REAL*8     M10,M01,M11,M20,M02,PM(1:3,1:NE),TM
IF  (DABS(TM-DT)<1.0D-6)  THEN
	M10=PM(1,LABEL)
	M01=PM(2,LABEL)
	M11=PM(1,LABEL)*PM(2,LABEL)
	M20=PM(1,LABEL)**2.0
	M02=PM(2,LABEL)**2.0
	CALL ODERK(M10,M01,M11,M20,M02,TM)
ELSE
	CALL ODERK(M10,M01,M11,M20,M02,TM)
END IF
END SUBROUTINE UPDATEM
!-------------------------------------------------------------------------------------------------------------------------!
SUBROUTINE ODERK(M10,M01,M11,M20,M02,TM)      !THIRD-ORDER TVD RUNGE-KUTTA FOR MOMENT EQUATIONS
IMPLICIT   NONE
REAL*8     TM,TM0,DT0
REAL*8     M10,M01,M11,M20,M02
REAL*8     M10_1,M01_1,M11_1,M20_1,M02_1
REAL*8     M10_2,M01_2,M11_2,M20_2,M02_2
REAL*8     M10_3,M01_3,M11_3,M20_3,M02_3
DT0=DT/NL0
TM0=TM-DT
DO  WHILE  (DABS(TM0-TM)>1.0D-3)
	!STEP 1
	M10_1=M10+DT0*RHS(M10,M01,M11,M20,M02,TM0,1)
	M01_1=M01+DT0*RHS(M10,M01,M11,M20,M02,TM0,2)
	M11_1=M11+DT0*RHS(M10,M01,M11,M20,M02,TM0,3)
	M20_1=M20+DT0*RHS(M10,M01,M11,M20,M02,TM0,4)
	M02_1=M02+DT0*RHS(M10,M01,M11,M20,M02,TM0,5)
	!STEP 2
	M10_2=0.75*M10+0.25*M10_1+0.25*DT0*RHS(M10_1,M01_1,M11_1,M20_1,M02_1,TM0,1)
	M01_2=0.75*M01+0.25*M01_1+0.25*DT0*RHS(M10_1,M01_1,M11_1,M20_1,M02_1,TM0,2)
	M11_2=0.75*M11+0.25*M11_1+0.25*DT0*RHS(M10_1,M01_1,M11_1,M20_1,M02_1,TM0,3)
	M20_2=0.75*M20+0.25*M20_1+0.25*DT0*RHS(M10_1,M01_1,M11_1,M20_1,M02_1,TM0,4)
	M02_2=0.75*M02+0.25*M02_1+0.25*DT0*RHS(M10_1,M01_1,M11_1,M20_1,M02_1,TM0,5)
	!STEP 3
	M10_3=M10/3.0+2.0*M10_2/3.0+2.0*DT0*RHS(M10_2,M01_2,M11_2,M20_2,M02_2,TM0,1)/3.0
	M01_3=M01/3.0+2.0*M01_2/3.0+2.0*DT0*RHS(M10_2,M01_2,M11_2,M20_2,M02_2,TM0,2)/3.0
	M11_3=M11/3.0+2.0*M11_2/3.0+2.0*DT0*RHS(M10_2,M01_2,M11_2,M20_2,M02_2,TM0,3)/3.0
	M20_3=M20/3.0+2.0*M20_2/3.0+2.0*DT0*RHS(M10_2,M01_2,M11_2,M20_2,M02_2,TM0,4)/3.0
	M02_3=M02/3.0+2.0*M02_2/3.0+2.0*DT0*RHS(M10_2,M01_2,M11_2,M20_2,M02_2,TM0,5)/3.0
	!UPDATE
	M10=M10_3
	M01=M01_3
	M11=M11_3
	M20=M20_3
	M02=M02_3
	!LOOP CONDITIONS
	TM0=TM0+DT0
END DO
END SUBROUTINE ODERK
!-------------------------------------------------------------------------------------------------------------------------!
FUNCTION  RHS(M10,M01,M11,M20,M02,TM,MARK)      !RIGHT-HAND-SIDE OF MOMENT EQUATIONS
IMPLICIT  NONE
INTEGER*4 MARK
REAL*8    RHS,M10,M01,M11,M20,M02,TM
IF  (MARK==1)  THEN      !FOR M10
    RHS=M01
END IF
IF  (MARK==2)  THEN      !FOR M01
    RHS=-YETA*M01-ALPHA*M10-3.0*BETA*M10*M20+2.0*BETA*M10**3.0+FF*DCOS(OMIGA*TM)
END IF
IF  (MARK==3)  THEN      !FOR M11
    RHS=M02-YETA*M11-ALPHA*M20-3.0*BETA*M20**2.0+2.0*BETA*M10**4.0+M10*FF*DCOS(OMIGA*TM)
END IF
IF  (MARK==4)  THEN      !FOR M20
    RHS=2.0*M11
END IF
IF  (MARK==5)  THEN      !FOR M02
    RHS=-2.0*YETA*M02-2.0*ALPHA*M11-6.0*BETA*M20*M11+4.0*BETA*M10**3.0*M01+SEGMA2+2.0*M01*FF*DCOS(OMIGA*TM)
END IF
END FUNCTION RHS
!-------------------------------------------------------------------------------------------------------------------------!
SUBROUTINE INITIAL(PM)      !INITIALIZE PROBABILITY DENSITY
IMPLICIT   NONE
INTEGER*4  I
REAL*8     PM(1:3,1:NE)
REAL*8     MEAN1,MEAN2,VAR1,VAR2,ROU12
MEAN1=-1.0
MEAN2=-1.0
VAR1=DSQRT(0.1D0)
VAR2=DSQRT(0.1D0)
ROU12=0.01
!READ ELEMENTS
OPEN(1,FILE='NE.TXT')
READ(1,*) ELEM
CLOSE(1)
OPEN(1,FILE='INI.DAT')
DO  I=1,NE
	!CALCULATE INITIAL PROBABILITY
	PM(1,I)=ELEM(1,I)      !X  COORDINATE
	PM(2,I)=ELEM(2,I)      !X' COORDINATE
	PM(3,I)=VAR2**2.0*(PM(1,I)-MEAN1)**2.0-2.0*VAR1*VAR2*ROU12*(PM(1,I)-MEAN1)*(PM(2,I)-MEAN2)+VAR1**2.0*(PM(2,I)-MEAN2)**2.0
	PM(3,I)=DEXP(-PM(3,I)/(2.0*VAR1**2.0*VAR2**2.0*(1.0-ROU12**2.0)))
	PM(3,I)=PM(3,I)/(2.0*PI*VAR1*VAR2*DSQRT(1.0-ROU12**2.0))
	WRITE(1,'(3(2X,F21.11))') PM(1,I),PM(2,I),PM(3,I) 
	!CALCULATE AREA OF ELEMENTS
	AREAS(I)=PI*ELEM(3,I)**2.0
END DO
CLOSE(1)
END SUBROUTINE INITIAL
!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++!
END
!+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++!
